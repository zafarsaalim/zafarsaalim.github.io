<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Invoice Form</title>
  <script src="./../ga.js"></script>
  <style>
    body { font-family: -apple-system,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial; padding:18px; }
    h2 { margin-top:0; }
    .row { display:flex; gap:8px; margin-bottom:8px; }
    .col { flex:1; display:flex; flex-direction:column; }
    label { font-size:12px; color:#333; margin-bottom:4px; }
    input, textarea, select { padding:8px; border:1px solid #ddd; border-radius:6px; font-size:14px; }
    textarea { min-height:60px; }
    .btn { padding:10px 12px; border-radius:8px; border:none; font-weight:600; cursor:pointer; }
    .btn-primary { background:#3b82f6; color:white; }
    .btn-ghost { background:#f3f4f6; color:#111; }
    table { width:100%; border-collapse:collapse; margin-bottom:8px; }
    th, td { border:1px solid #e5e7eb; padding:8px; text-align:left; font-size:14px; }
    .small { font-size:12px; color:#666; }
    .actions { display:flex; gap:8px; margin-top:10px; justify-content:flex-end; }
    .footer { margin-top:12px; font-size:12px; color:#444; text-align:center; }
  </style>
</head>
<body>
  <h2>Invoice Form</h2>

  <div>
    <strong>Seller</strong>
    <div class="row">
      <div class="col">
        <label>Seller Name</label>
        <input id="seller_name" placeholder="ABC Traders" />
      </div>
      <div class="col">
        <label>Phone</label>
        <input id="seller_phone" placeholder="9988776655" />
      </div>
    </div>
    <div>
      <label>Address</label>
      <textarea id="seller_address" placeholder="123 Market Road, City - PIN"></textarea>
    </div>
    <div class="row">
      <div class="col">
        <label>GST (optional)</label>
        <input id="seller_gst" placeholder="27ABCDE1234F1Z2" />
      </div>
      <div class="col">
        <label>Logo URL (optional)</label>
        <input id="logo_url" placeholder="https://..." />
      </div>
    </div>
  </div>

  <hr/>

  <div>
    <strong>Buyer</strong>
    <div class="row">
      <div class="col">
        <label>Buyer Name</label>
        <input id="buyer_name" placeholder="John Enterprises" />
      </div>
      <div class="col">
        <label>Phone (optional)</label>
        <input id="buyer_phone" placeholder="Phone" />
      </div>
    </div>
    <div>
      <label>Address</label>
      <textarea id="buyer_address" placeholder="22 Park Street, City - PIN"></textarea>
    </div>
    <div class="row">
      <div class="col">
        <label>GST (optional)</label>
        <input id="buyer_gst" placeholder="GSTIN" />
      </div>
      <div class="col">
        <label>Currency</label>
        <input id="currency" placeholder="INR" value="INR" />
      </div>
    </div>
  </div>

  <hr/>

  <div>
    <strong>Invoice</strong>
    <div class="row">
      <div class="col">
        <label>Invoice Number</label>
        <input id="invoice_no" placeholder="INV-2025-001" />
      </div>
      <div class="col">
        <label>Invoice Date</label>
        <input id="invoice_date" type="date" />
      </div>
      <div class="col">
        <label>Due Date</label>
        <input id="due_date" type="date" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Tax %</label>
        <input id="tax_percent" type="number" step="0.01" value="0" />
      </div>
      <div class="col">
        <label>Notes</label>
        <input id="notes" placeholder="Payment due in 7 days" />
      </div>
    </div>
  </div>

  <hr/>

  <div>
    <strong>Items</strong>
    <div style="overflow:auto; max-height:260px;">
      <table id="items_table">
        <thead><tr><th>#</th><th>Description</th><th>Qty</th><th>Unit Price</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="row">
      <input id="it_name" placeholder="Item description" />
      <input id="it_qty" type="number" placeholder="Qty" style="width:90px"/>
      <input id="it_price" type="number" placeholder="Unit price" style="width:130px"/>
      <button id="add_item" class="btn btn-ghost">Add</button>
    </div>
  </div>

  <div class="actions">
    <button id="submit" class="btn btn-primary">Submit Invoice</button>
  </div>

  <div class="footer small">
    This form will run inside Telegram. Data will be sent to the bot securely.
  </div>

<script>
  // Telegram WebApp integration
  const tg = window.Telegram.WebApp || null;
  if (tg) {
    tg.expand(); // optional: expand to full height inside Telegram
  }

  // helpers
  function $(id){ return document.getElementById(id); }

  const tbody = document.querySelector('#items_table tbody');

  function refreshItems() {
    tbody.innerHTML = '';
    items.forEach((it, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${escapeHtml(it.name)}</td>
        <td>${it.qty}</td>
        <td>${Number(it.price).toFixed(2)}</td>
        <td><button data-i="${idx}" class="del">Delete</button></td>
      `;
      tbody.appendChild(tr);
    });
    document.querySelectorAll('.del').forEach(b=>{
      b.onclick = (e)=>{
        const i = Number(e.target.dataset.i);
        items.splice(i,1);
        refreshItems();
      };
    });
  }
  function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  let items = [];

  $('add_item').addEventListener('click', function(e){
    const name = $('it_name').value.trim();
    const qty = Number($('it_qty').value || 0);
    const price = Number($('it_price').value || 0);
    if (!name) { alert('Enter item description'); return; }
    if (!qty || qty <= 0) { alert('Enter valid quantity'); return; }
    if (isNaN(price)) { alert('Enter valid price'); return; }
    items.push({name, qty, price});
    $('it_name').value=''; $('it_qty').value=''; $('it_price').value='';
    refreshItems();
  });

  $('submit').addEventListener('click', function(){
    // basic validation
    const seller_name = $('seller_name').value.trim();
    const seller_address = $('seller_address').value.trim();
    const buyer_name = $('buyer_name').value.trim();
    const invoice_no = $('invoice_no').value.trim();

    if (!seller_name || !seller_address) { alert('Enter seller name and address'); return; }
    if (!buyer_name) { alert('Enter buyer name'); return; }
    if (!invoice_no) { alert('Enter invoice number'); return; }
    if (items.length === 0) { if (!confirm('No items added. Continue?')) return; }

    const payload = {
      seller: {
        name: seller_name,
        address: seller_address,
        phone: $('seller_phone').value.trim(),
        gst: $('seller_gst').value.trim()
      },
      buyer: {
        name: buyer_name,
        address: $('buyer_address').value.trim(),
        phone: $('buyer_phone').value.trim(),
        gst: $('buyer_gst').value.trim()
      },
      invoice: {
        number: invoice_no,
        date: $('invoice_date').value || new Date().toISOString().slice(0,10),
        due_date: $('due_date').value || '',
        tax_percent: Number($('tax_percent').value || 0),
        currency: $('currency').value || 'INR'
      },
      items: items,
      notes: $('notes').value.trim(),
      logo_url: $('logo_url').value.trim()
    };

    const jsonStr = JSON.stringify(payload);
    if (tg && tg.sendData) {
      tg.sendData(jsonStr);
      // optionally close the webapp
      setTimeout(()=>tg.close(), 300);
    } else {
      // If opened in a browser for debugging, show the JSON
      console.log("payload:", payload);
      alert("WebApp not running inside Telegram. Check console for payload.");
    }
  });

  // initial
  refreshItems();
</script>
</body>
</html>
