<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Invoice Form</title>

  <!-- MANDATORY for Telegram -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body { font-family: Arial; padding:18px; }
    h2 { margin-top:0; }
    .row { display:flex; gap:8px; margin-bottom:8px; }
    .col { flex:1; display:flex; flex-direction:column; }
    input, textarea { padding:8px; border:1px solid #ddd; border-radius:6px; }
    .btn { padding:10px; border-radius:8px; cursor:pointer; }
    .btn-primary { background:#3b82f6; color:white; }
    .btn-ghost { background:#eee; }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { border:1px solid #ccc; padding:8px; font-size:14px; }
  </style>
</head>
<body>

<h2>Invoice Form</h2>

<!-- Seller -->
<div>
  <b>Seller</b>
  <div class="row">
    <div class="col"><input id="seller_name" placeholder="Seller Name"></div>
    <div class="col"><input id="seller_phone" placeholder="Phone"></div>
  </div>
  <textarea id="seller_address" placeholder="Address"></textarea>
  <div class="row">
    <div class="col"><input id="seller_gst" placeholder="GST"></div>
    <div class="col"><input id="logo_url" placeholder="Logo URL"></div>
  </div>
</div>

<hr>

<!-- Buyer -->
<div>
  <b>Buyer</b>
  <div class="row">
    <div class="col"><input id="buyer_name" placeholder="Buyer Name"></div>
    <div class="col"><input id="buyer_phone" placeholder="Phone"></div>
  </div>
  <textarea id="buyer_address" placeholder="Address"></textarea>
  <div class="row">
    <div class="col"><input id="buyer_gst" placeholder="GST"></div>
    <div class="col"><input id="currency" value="INR"></div>
  </div>
</div>

<hr>

<!-- Invoice -->
<div>
  <b>Invoice</b>
  <div class="row">
    <div class="col"><input id="invoice_no" placeholder="Invoice No"></div>
    <div class="col"><input id="invoice_date" type="date"></div>
    <div class="col"><input id="due_date" type="date"></div>
  </div>
  <div class="row">
    <div class="col"><input id="tax_percent" type="number" value="0" placeholder="Tax %"></div>
    <div class="col"><input id="notes" placeholder="Notes"></div>
  </div>
</div>

<hr>

<!-- ITEMS -->
<b>Items</b>

<table>
  <thead>
    <tr><th>#</th><th>Description</th><th>Qty</th><th>Price</th><th></th></tr>
  </thead>
  <tbody id="items_body"></tbody>
</table>

<div class="row">
  <input id="it_name" placeholder="Item name">
  <input id="it_qty" type="number" placeholder="Qty">
  <input id="it_price" type="number" placeholder="Price">
  <button class="btn btn-ghost" id="add_item">Add</button>
</div>

<br>

<button id="submit" class="btn btn-primary">Submit Invoice</button>

<script>
const tg = window.Telegram.WebApp;
tg.ready();       // VERY IMPORTANT
tg.expand();      // Optional

function $(id) { return document.getElementById(id); }

let items = [];

function refreshTable() {
  const body = $("items_body");
  body.innerHTML = "";
  items.forEach((it, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i+1}</td>
      <td>${it.name}</td>
      <td>${it.qty}</td>
      <td>${it.price}</td>
      <td><button data-i="${i}" class="del">X</button></td>
    `;
    body.appendChild(row);
  });

  document.querySelectorAll(".del").forEach(btn=>{
    btn.onclick = () => {
      items.splice(btn.dataset.i, 1);
      refreshTable();
    };
  });
}

$("add_item").onclick = () => {
  const name = $("it_name").value.trim();
  const qty  = Number($("it_qty").value);
  const price = Number($("it_price").value);

  if (!name || qty <= 0 || price <= 0) {
    alert("Invalid item");
    return;
  }

  items.push({ name, qty, price });

  $("it_name").value = "";
  $("it_qty").value = "";
  $("it_price").value = "";

  refreshTable();
};

$("submit").onclick = () => {
  const payload = {
    seller: {
      name: $("seller_name").value,
      address: $("seller_address").value,
      phone: $("seller_phone").value,
      gst: $("seller_gst").value
    },
    buyer: {
      name: $("buyer_name").value,
      address: $("buyer_address").value,
      phone: $("buyer_phone").value,
      gst: $("buyer_gst").value
    },
    invoice: {
      number: $("invoice_no").value,
      date: $("invoice_date").value,
      due_date: $("due_date").value,
      tax_percent: Number($("tax_percent").value),
      currency: $("currency").value
    },
    items: items,
    notes: $("notes").value,
    logo_url: $("logo_url").value
  };

  tg.sendData(JSON.stringify(payload));
  tg.close();
};

</script>

</body>
</html>
